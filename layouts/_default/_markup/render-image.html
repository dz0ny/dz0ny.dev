{{- $src := .Page.Resources.GetMatch .Destination -}}
{{- $alt := .Text -}}
{{- $title := .Title -}}
{{- $attrs := .Attributes -}}

{{- if $src -}}
  {{- /* Image exists as page resource, process it */ -}}
  {{- $maxWidth := 1200 -}}

  {{- /* Check for custom width in attributes */ -}}
  {{- $customWidth := 0 -}}
  {{- with $attrs.width -}}
    {{- $customWidth = int . -}}
  {{- end -}}

  {{- /* Resize image for optimal web delivery */ -}}
  {{- $resized := $src.Resize (printf "%dx webp q85" $maxWidth) -}}

  {{- /* Create responsive srcset with multiple sizes */ -}}
  {{- $sizes := slice 320 640 960 1280 -}}
  {{- $srcset := slice -}}

  {{- range $sizes -}}
    {{- if ge $src.Width . -}}
      {{- $img := $src.Resize (printf "%dx webp q85" .) -}}
      {{- $srcset = $srcset | append (printf "%s %dw" $img.RelPermalink .) -}}
    {{- end -}}
  {{- end -}}

  <img
    src="{{ $resized.RelPermalink }}"
    {{- with $srcset }} srcset="{{ delimit . ", " }}"{{ end }}
    {{- if $customWidth }}
    sizes="{{ $customWidth }}px"
    width="{{ $customWidth }}"
    {{- else }}
    sizes="(min-width: 1024px) 100vw, 50vw"
    width="{{ $src.Width }}"
    {{- end }}
    height="auto"
    {{- with $alt }} alt="{{ . }}"{{ end }}
    {{- with $title }} title="{{ . }}"{{ end }}
    {{- with $attrs.class }} class="{{ . }}"{{ end }}
    {{- with $attrs.style }} style="{{ . }}"{{ end }}
    loading="lazy"
    decoding="async"
  >
{{- else -}}
  {{- /* Fallback for non-page-resource images (e.g., external URLs) */ -}}
  <img
    src="{{ .Destination | safeURL }}"
    {{- with $alt }} alt="{{ . }}"{{ end }}
    {{- with $title }} title="{{ . }}"{{ end }}
    {{- with $attrs.width }} width="{{ . }}"{{ end }}
    {{- with $attrs.class }} class="{{ . }}"{{ end }}
    {{- with $attrs.style }} style="{{ . }}"{{ end }}
    loading="lazy"
  >
{{- end -}}
